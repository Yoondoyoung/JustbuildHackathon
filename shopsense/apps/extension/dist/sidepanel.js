import{s as g}from"./chunks/supabase.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))c(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function c(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const _=(e,t,n)=>{var s,o,i;e.innerHTML="";const c=document.createElement("p");if(c.textContent=t.summary??"No summary available.",e.appendChild(c),t.price){const a=document.createElement("div");a.className="meta-row",a.textContent=`Price: ${t.price.value} ${t.price.currency}`,e.appendChild(a)}if(t.rating!==void 0){const a=document.createElement("div");a.className="meta-row",a.textContent=`Rating: ${t.rating}`,e.appendChild(a)}if(t.review_count!==void 0){const a=document.createElement("div");a.className="meta-row",a.textContent=`Reviews: ${t.review_count}`,e.appendChild(a)}if((s=t.key_points)!=null&&s.length){const a=document.createElement("ul");t.key_points.forEach(l=>{const r=document.createElement("li");r.textContent=l,a.appendChild(r)}),e.appendChild(a)}if(t.specs&&Object.keys(t.specs).length>0){const a=document.createElement("div");a.className="specs",Object.entries(t.specs).forEach(([l,r])=>{const d=document.createElement("div");d.className="spec-row",d.textContent=`${l}: ${r}`,a.appendChild(d)}),e.appendChild(a)}if((o=t.citations)!=null&&o.length){const a=document.createElement("div");a.className="citations",t.citations.forEach(l=>{const r=document.createElement("a");r.href=l.url,r.target="_blank",r.rel="noreferrer",r.textContent=l.title??l.url,a.appendChild(r)}),e.appendChild(a)}if((i=t.suggested_questions)!=null&&i.length){const a=document.createElement("div");a.className="suggested-questions",t.suggested_questions.forEach(l=>{const r=document.createElement("button");r.type="button",r.className="suggested-question-btn",r.textContent=l,r.style.display="block",r.style.width="100%",r.style.textAlign="left",r.style.padding="0.5rem 0.75rem",r.style.marginBottom="0.35rem",r.style.cursor="pointer",r.style.border="1px solid var(--border, #e0e0e0)",r.style.borderRadius="4px",r.style.background="var(--bg-secondary, #f5f5f5)",r.style.fontSize="0.9rem",n&&r.addEventListener("click",()=>n(l)),a.appendChild(r)}),e.appendChild(a)}};function y(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function O(e){if(!e||typeof e!="string")return"";const t=[],n=/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g;let c=0,s;for(;(s=n.exec(e))!==null;)t.push(y(e.slice(c,s.index)).replace(/\n/g,"<br>").replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")),t.push(`<a href="${y(s[2])}" target="_blank" rel="noreferrer noopener">${y(s[1])}</a>`),c=n.lastIndex;return t.push(y(e.slice(c)).replace(/\n/g,"<br>").replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")),t.join("")}const A=(e,t)=>{var s;const n=document.createElement("div");n.className=`chat-message ${t.role}`;const c=document.createElement("div");if(c.className="chat-text",c.innerHTML=O(t.content),n.appendChild(c),(s=t.citations)!=null&&s.length){const o=document.createElement("div");o.className="chat-citations",t.citations.forEach(i=>{const a=document.createElement("a");a.href=i.url,a.target="_blank",a.rel="noreferrer",a.textContent=i.title??i.url,o.appendChild(a)}),n.appendChild(o)}e.appendChild(n),e.scrollTop=e.scrollHeight},H=async()=>{const{data:{session:e}}=await g.auth.getSession();return{isAuthenticated:!!e,user:(e==null?void 0:e.user)??null}},P=async(e,t)=>{const{data:n,error:c}=await g.auth.signUp({email:e,password:t});if(c)throw c;return n},D=async(e,t)=>{const{data:n,error:c}=await g.auth.signInWithPassword({email:e,password:t});if(c)throw c;return n},R=e=>g.auth.onAuthStateChange((t,n)=>{e({isAuthenticated:!!n,user:(n==null?void 0:n.user)??null})}),U=(e,t)=>{e.innerHTML="";const n=document.createElement("div");n.className="auth-container";const c=document.createElement("h2");c.textContent="ShopSense",c.className="auth-title",n.appendChild(c);const s=document.createElement("div");s.className="auth-tabs";const o=document.createElement("button");o.textContent="로그인",o.className="auth-tab active",o.dataset.mode="login";const i=document.createElement("button");i.textContent="회원가입",i.className="auth-tab",i.dataset.mode="signup",s.appendChild(o),s.appendChild(i),n.appendChild(s);const a=document.createElement("form");a.className="auth-form";const l=document.createElement("input");l.type="email",l.placeholder="이메일",l.required=!0,l.className="auth-input",a.appendChild(l);const r=document.createElement("input");r.type="password",r.placeholder="비밀번호",r.required=!0,r.className="auth-input",a.appendChild(r);const d=document.createElement("div");d.className="auth-error",d.style.display="none",a.appendChild(d);const u=document.createElement("button");u.type="submit",u.textContent="로그인",u.className="btn btn-primary auth-submit",a.appendChild(u),n.appendChild(a),e.appendChild(n);let h="login";const k=m=>{h=m,o.classList.toggle("active",m==="login"),i.classList.toggle("active",m==="signup"),u.textContent=m==="login"?"로그인":"회원가입",d.style.display="none",d.textContent=""};o.addEventListener("click",()=>k("login")),i.addEventListener("click",()=>k("signup")),a.addEventListener("submit",async m=>{m.preventDefault(),d.style.display="none",d.textContent="";const b=l.value.trim(),E=r.value;if(!b||!E){d.textContent="이메일과 비밀번호를 입력해주세요.",d.style.display="block";return}u.disabled=!0,u.textContent=h==="login"?"로그인 중...":"회원가입 중...";try{h==="login"?await D(b,E):await P(b,E),t()}catch($){d.textContent=$.message||"오류가 발생했습니다.",d.style.display="block"}finally{u.disabled=!1,u.textContent=h==="login"?"로그인":"회원가입"}})},v=document.querySelector("#status-dot"),j=document.querySelector("#status-text"),I=document.querySelector("#analyze"),L=document.querySelector("#chat"),B=document.querySelector("#analyze-btn"),T=document.querySelector("#chat-form"),N=document.querySelector("#chat-input"),f=document.querySelector("#auth-container"),M=document.querySelector("#main-content"),p=e=>{j.textContent=e;const t=e.toLowerCase();v.classList.remove("busy","error"),t.includes("fail")||t.includes("error")?v.classList.add("error"):(t.includes("analyz")||t.includes("send"))&&v.classList.add("busy")},C=async()=>{var n;const t=(n=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0])==null?void 0:n.id;if(typeof t!="number")throw new Error("No active tab found");return t},S=async e=>{await chrome.runtime.sendMessage(e)},x=()=>{f.style.display="none",M.style.display="block"},w=()=>{f.style.display="flex",M.style.display="none",f.innerHTML="",U(f,x)},z=async e=>{try{const t=await C();await S({type:"CHAT_SEND",tabId:t,question:e})}catch{p("Failed to send question.")}},q=async()=>{try{const e=await C(),t=await chrome.runtime.sendMessage({type:"PANEL_INIT",tabId:e});t!=null&&t.result&&_(I,t.result,z),Array.isArray(t==null?void 0:t.history)&&t.history.forEach(n=>{A(L,n)})}catch{p("Unable to initialize panel.")}},F=async()=>{try{(await H()).isAuthenticated?(x(),await q()):w(),R(t=>{t.isAuthenticated?(x(),q()):w()})}catch(e){console.error("Auth check failed:",e),w()}};B.addEventListener("click",async()=>{try{p("Analyzing...");const e=await C();await S({type:"ANALYZE_CLICK",tabId:e})}catch{p("Analyze failed.")}});T.addEventListener("submit",async e=>{e.preventDefault();const t=N.value.trim();if(t)try{const n=await C();A(L,{role:"user",content:t}),N.value="",await S({type:"CHAT_SEND",tabId:n,question:t})}catch{p("Chat failed.")}});N.addEventListener("keydown",e=>{e.isComposing||e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),T.requestSubmit())});chrome.runtime.onMessage.addListener((e,t,n)=>e.type==="STATUS"?(p(e.message),n({ok:!0}),!0):e.type==="ERROR"?(p(e.message),n({ok:!0}),!0):e.type==="ANALYZE_RESULT"?(_(I,e.result,z),p("Analyze completed"),n({ok:!0}),!0):e.type==="CHAT_RESPONSE"?(A(L,e.message),p("Chat ready"),n({ok:!0}),!0):!1);F();
