import{s as o}from"./chunks/supabase.js";const _="http://localhost:8787",w=async()=>{const e=await chrome.storage.sync.get("apiBase");return typeof e.apiBase=="string"&&e.apiBase.length>0?e.apiBase:_},b=async e=>{const a=await w(),r=await fetch(`${a}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({extracted:e})});if(!r.ok)throw new Error(`Analyze failed: ${r.status}`);return await r.json()},S=async e=>{const a=await w(),r=await fetch(`${a}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok)throw new Error(`Chat failed: ${r.status}`);return await r.json()},m="src/ui/sidepanel.html",C=()=>{var e,a;return typeof((e=chrome.sidePanel)==null?void 0:e.setOptions)=="function"&&typeof((a=chrome.sidePanel)==null?void 0:a.open)=="function"};chrome.runtime.onInstalled.addListener(()=>{C()&&chrome.sidePanel.setOptions({path:m,enabled:!0})});chrome.action.onClicked.addListener(async e=>{if(typeof e.id=="number")try{await chrome.tabs.sendMessage(e.id,{type:"TOGGLE_SIDEBAR"})}catch{}});const f=new Map,d=new Map,y=new Map,u=e=>{try{const a=chrome.runtime.sendMessage(e);a&&typeof a.catch=="function"&&a.catch(()=>{})}catch{}},g=(e,a)=>{try{const r=chrome.tabs.sendMessage(e,a);r&&typeof r.catch=="function"&&r.catch(()=>{})}catch{}},s=(e,a)=>{u({type:"STATUS",tabId:e,message:a})},E=(e,a)=>{u({type:"ERROR",tabId:e,message:a})},P=(e,a)=>{const r={type:"ANALYZE_RESULT",tabId:e,result:a};u(r),g(e,r)},T=(e,a)=>{const r={type:"CHAT_RESPONSE",tabId:e,message:a};u(r),g(e,r)},I=e=>({title:e.title,summary:e.title?`Analyzed ${e.title}`:"Basic analyze fallback used.",specs:e.key_specs,price:e.price,rating:e.rating,review_count:e.review_count,suggested_questions:["Is this good value for money?","What do reviews say about it?","How does it compare to similar products?"]}),k=async e=>await chrome.tabs.sendMessage(e,{type:"EXTRACT_REQUEST"});chrome.runtime.onMessage.addListener((e,a,r)=>{var p;const h=()=>{var t;return("tabId"in e?e.tabId:void 0)??((t=a.tab)==null?void 0:t.id)};if(e.type==="GET_TAB_ID")return r({tabId:((p=a.tab)==null?void 0:p.id)??null}),!0;if(e.type==="ANALYZE_CLICK"){const t=h();return typeof t!="number"?(r({ok:!1,error:"No tab id available"}),!0):((async()=>{try{s(t,"Extracting page data...");const n=await k(t);d.set(t,n),s(t,"Calling analyze API...");let i;try{i=await b(n)}catch{i=I(n),s(t,"Analyze API failed, using fallback.")}f.set(t,i),P(t,i),r({ok:!0})}catch(n){const i=n instanceof Error?n.message:"Analyze failed";E(t,i),r({ok:!1,error:i})}})(),!0)}if(e.type==="CHAT_SEND"){const t=h();return typeof t!="number"?(r({ok:!1,error:"No tab id available"}),!0):((async()=>{try{const n=f.get(t),i=d.get(t);s(t,"Sending chat request...");let c;try{c=(await S({question:e.question,analyze:n,extracted:i})).message}catch{c={role:"assistant",content:"Chat API failed. Please try again."},s(t,"Chat API failed, using fallback.")}const l=y.get(t)??[];l.push({role:"user",content:e.question}),l.push(c),y.set(t,l),T(t,c),r({ok:!0})}catch(n){const i=n instanceof Error?n.message:"Chat failed";E(t,i),r({ok:!1,error:i})}})(),!0)}if(e.type==="PANEL_INIT"){const t=f.get(e.tabId),n=y.get(e.tabId)??[];return r({ok:!0,result:t,history:n}),!0}return e.type==="CHECK_AUTH"?((async()=>{try{const{data:{session:t}}=await o.auth.getSession();r({isAuthenticated:!!t})}catch{r({isAuthenticated:!1,error:"Auth check failed"})}})(),!0):e.type==="SIGN_IN"?((async()=>{try{const{data:t,error:n}=await o.auth.signInWithPassword({email:e.email,password:e.password});r(n?{error:n.message}:{ok:!0})}catch(t){r({error:t.message||"Sign in failed"})}})(),!0):e.type==="SIGN_UP"?((async()=>{try{const{data:t,error:n}=await o.auth.signUp({email:e.email,password:e.password});r(n?{error:n.message}:{ok:!0})}catch(t){r({error:t.message||"Sign up failed"})}})(),!0):e.type==="CHECK_PREFERENCES"?((async()=>{try{const{data:{session:t}}=await o.auth.getSession();if(!(t!=null&&t.user)){r({hasPreferences:!1});return}const{data:n,error:i}=await o.from("user_preferences").select("id").eq("user_id",t.user.id).single();r({hasPreferences:!!n&&!i})}catch{r({hasPreferences:!1})}})(),!0):e.type==="GET_PREFERENCES"?((async()=>{try{const{data:{session:t}}=await o.auth.getSession();if(!(t!=null&&t.user)){r({preferences:null});return}const{data:n,error:i}=await o.from("user_preferences").select("*").eq("user_id",t.user.id).single();i&&i.code!=="PGRST116"?r({preferences:null,error:i.message}):r({preferences:n||null})}catch(t){r({preferences:null,error:t.message})}})(),!0):e.type==="SAVE_PREFERENCES"?((async()=>{try{const{data:{session:t}}=await o.auth.getSession();if(!(t!=null&&t.user)){r({error:"Not authenticated"});return}const{error:n}=await o.from("user_preferences").upsert({user_id:t.user.id,price_sensitivity:e.preferences.price||null,quality_preference:e.preferences.quality||null,brand_preference:e.preferences.brand||null,sustainability:e.preferences.sustainability||null,review_dependency:e.preferences.reviews||null,innovation_adoption:e.preferences.innovation||null},{onConflict:"user_id"});r(n?{error:n.message}:{ok:!0})}catch(t){r({error:t.message||"Failed to save preferences"})}})(),!0):!1});
