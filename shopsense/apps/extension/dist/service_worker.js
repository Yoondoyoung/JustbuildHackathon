const b="http://localhost:8787",g=async()=>{const t=await chrome.storage.sync.get("apiBase");return typeof t.apiBase=="string"&&t.apiBase.length>0?t.apiBase:b},m=async t=>{const e=await g(),n=await fetch(`${e}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({extracted:t})});if(!n.ok)throw new Error(`Analyze failed: ${n.status}`);return await n.json()},E=async t=>{const e=await g(),n=await fetch(`${e}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`Chat failed: ${n.status}`);return await n.json()},w="src/ui/sidepanel.html",T=()=>{var t,e;return typeof((t=chrome.sidePanel)==null?void 0:t.setOptions)=="function"&&typeof((e=chrome.sidePanel)==null?void 0:e.open)=="function"};chrome.runtime.onInstalled.addListener(()=>{T()&&chrome.sidePanel.setOptions({path:w,enabled:!0})});chrome.action.onClicked.addListener(async t=>{if(typeof t.id=="number")try{await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{}});const u=new Map,d=new Map,y=new Map,i=t=>{try{const e=chrome.runtime.sendMessage(t);e&&typeof e.catch=="function"&&e.catch(()=>{})}catch{}},c=(t,e)=>{i({type:"STATUS",tabId:t,message:e})},f=(t,e)=>{i({type:"ERROR",tabId:t,message:e})},I=(t,e)=>{i({type:"ANALYZE_RESULT",tabId:t,result:e})},C=(t,e)=>{i({type:"CHAT_RESPONSE",tabId:t,message:e})},S=t=>({title:t.title,summary:t.title?`Analyzed ${t.title}`:"Basic analyze fallback used.",specs:t.key_specs,price:t.price,rating:t.rating,review_count:t.review_count}),P=async t=>await chrome.tabs.sendMessage(t,{type:"EXTRACT_REQUEST"});chrome.runtime.onMessage.addListener((t,e,n)=>{var p;const h=()=>{var a;return("tabId"in t?t.tabId:void 0)??((a=e.tab)==null?void 0:a.id)};if(t.type==="GET_TAB_ID")return n({tabId:((p=e.tab)==null?void 0:p.id)??null}),!0;if(t.type==="ANALYZE_CLICK"){const a=h();return typeof a!="number"?(n({ok:!1,error:"No tab id available"}),!0):((async()=>{try{c(a,"Extracting page data...");const r=await P(a);d.set(a,r),c(a,"Calling analyze API...");let s;try{s=await m(r)}catch{s=S(r),c(a,"Analyze API failed, using fallback.")}u.set(a,s),I(a,s),n({ok:!0})}catch(r){const s=r instanceof Error?r.message:"Analyze failed";f(a,s),n({ok:!1,error:s})}})(),!0)}if(t.type==="CHAT_SEND"){const a=h();return typeof a!="number"?(n({ok:!1,error:"No tab id available"}),!0):((async()=>{try{const r=u.get(a),s=d.get(a);c(a,"Sending chat request...");let o;try{o=(await E({question:t.question,analyze:r,extracted:s})).message}catch{o={role:"assistant",content:"Chat API failed. Please try again."},c(a,"Chat API failed, using fallback.")}const l=y.get(a)??[];l.push({role:"user",content:t.question}),l.push(o),y.set(a,l),C(a,o),n({ok:!0})}catch(r){const s=r instanceof Error?r.message:"Chat failed";f(a,s),n({ok:!1,error:s})}})(),!0)}if(t.type==="PANEL_INIT"){const a=u.get(t.tabId),r=y.get(t.tabId)??[];return n({ok:!0,result:a,history:r}),!0}return!1});
