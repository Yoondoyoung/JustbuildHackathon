const A="http://localhost:8787",f=async()=>{const t=await chrome.storage.sync.get("apiBase");return typeof t.apiBase=="string"&&t.apiBase.length>0?t.apiBase:A},m=async t=>{const n=await f(),e=await fetch(`${n}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({extracted:t})});if(!e.ok)throw new Error(`Analyze failed: ${e.status}`);return await e.json()},E=async t=>{const n=await f(),e=await fetch(`${n}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(`Chat failed: ${e.status}`);return await e.json()},b="src/ui/sidepanel.html",w=()=>{var t,n;return typeof((t=chrome.sidePanel)==null?void 0:t.setOptions)=="function"&&typeof((n=chrome.sidePanel)==null?void 0:n.open)=="function"};chrome.runtime.onInstalled.addListener(()=>{w()&&chrome.sidePanel.setOptions({path:b,enabled:!0})});chrome.action.onClicked.addListener(async t=>{if(typeof t.id=="number")try{await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{await chrome.scripting.executeScript({target:{tabId:t.id},files:["contentScript.js"]}),await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}});const l=new Map,p=new Map,u=new Map,i=(t,n)=>{const e={type:"STATUS",tabId:t,message:n};chrome.runtime.sendMessage(e)},h=(t,n)=>{const e={type:"ERROR",tabId:t,message:n};chrome.runtime.sendMessage(e)},I=(t,n)=>{const e={type:"ANALYZE_RESULT",tabId:t,result:n};chrome.runtime.sendMessage(e)},T=(t,n)=>{const e={type:"CHAT_RESPONSE",tabId:t,message:n};chrome.runtime.sendMessage(e)},S=t=>({title:t.title,summary:t.title?`Analyzed ${t.title}`:"Basic analyze fallback used.",specs:t.key_specs,price:t.price,rating:t.rating,review_count:t.review_count}),C=async t=>await chrome.tabs.sendMessage(t,{type:"EXTRACT_REQUEST"});chrome.runtime.onMessage.addListener((t,n,e)=>{var d;const y=()=>{var a;return("tabId"in t?t.tabId:void 0)??((a=n.tab)==null?void 0:a.id)};if(t.type==="GET_TAB_ID")return e({tabId:((d=n.tab)==null?void 0:d.id)??null}),!0;if(t.type==="ANALYZE_CLICK"){const a=y();return typeof a!="number"?(e({ok:!1,error:"No tab id available"}),!0):((async()=>{try{i(a,"Extracting page data...");const r=await C(a);p.set(a,r),i(a,"Calling analyze API...");let s;try{s=await m(r)}catch{s=S(r),i(a,"Analyze API failed, using fallback.")}l.set(a,s),I(a,s),e({ok:!0})}catch(r){const s=r instanceof Error?r.message:"Analyze failed";h(a,s),e({ok:!1,error:s})}})(),!0)}if(t.type==="CHAT_SEND"){const a=y();return typeof a!="number"?(e({ok:!1,error:"No tab id available"}),!0):((async()=>{try{const r=l.get(a),s=p.get(a);i(a,"Sending chat request...");let o;try{o=(await E({question:t.question,analyze:r,extracted:s})).message}catch{o={role:"assistant",content:"Chat API failed. Please try again."},i(a,"Chat API failed, using fallback.")}const c=u.get(a)??[];c.push({role:"user",content:t.question}),c.push(o),u.set(a,c),T(a,o),e({ok:!0})}catch(r){const s=r instanceof Error?r.message:"Chat failed";h(a,s),e({ok:!1,error:s})}})(),!0)}if(t.type==="PANEL_INIT"){const a=l.get(t.tabId),r=u.get(t.tabId)??[];return e({ok:!0,result:a,history:r}),!0}return!1});
