import{s as o}from"./chunks/supabase.js";const _="http://localhost:8787",A=async()=>{const t=await chrome.storage.sync.get("apiBase");return typeof t.apiBase=="string"&&t.apiBase.length>0?t.apiBase:_},b=async t=>{const a=await A(),r=await fetch(`${a}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({extracted:t})});if(!r.ok)throw new Error(`Analyze failed: ${r.status}`);return await r.json()},C=async t=>{const a=await A(),r=await fetch(`${a}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Chat failed: ${r.status}`);return await r.json()},T="src/ui/sidepanel.html",I=()=>{var t,a;return typeof((t=chrome.sidePanel)==null?void 0:t.setOptions)=="function"&&typeof((a=chrome.sidePanel)==null?void 0:a.open)=="function"};chrome.runtime.onInstalled.addListener(()=>{I()&&chrome.sidePanel.setOptions({path:T,enabled:!0})});chrome.action.onClicked.addListener(async t=>{if(typeof t.id=="number")try{await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{}});const f=new Map,w=new Map,y=new Map,P=async()=>{try{const t=await chrome.storage.local.get("authCredentials"),a=t==null?void 0:t.authCredentials;return a&&typeof a.email=="string"&&typeof a.password=="string"?a:null}catch{return null}},g=async(t,a)=>{try{await chrome.storage.local.set({authCredentials:{email:t,password:a}})}catch{}},k=async()=>{const t=await P();if(!t)return!1;const{data:a,error:r}=await o.auth.signInWithPassword({email:t.email,password:t.password});return r?!1:!!a.session},u=t=>{try{const a=chrome.runtime.sendMessage(t);a&&typeof a.catch=="function"&&a.catch(()=>{})}catch{}},S=(t,a)=>{try{const r=chrome.tabs.sendMessage(t,a);r&&typeof r.catch=="function"&&r.catch(()=>{})}catch{}},s=(t,a)=>{u({type:"STATUS",tabId:t,message:a})},E=(t,a)=>{u({type:"ERROR",tabId:t,message:a})},N=(t,a)=>{const r={type:"ANALYZE_RESULT",tabId:t,result:a};u(r),S(t,r)},v=(t,a)=>{const r={type:"CHAT_RESPONSE",tabId:t,message:a};u(r),S(t,r)},z=t=>({title:t.title,summary:t.title?`Analyzed ${t.title}`:"Basic analyze fallback used.",specs:t.key_specs,price:t.price,rating:t.rating,review_count:t.review_count,suggested_questions:["Is this good value for money?","What do reviews say about it?","How does it compare to similar products?"]}),B=async t=>await chrome.tabs.sendMessage(t,{type:"EXTRACT_REQUEST"});chrome.runtime.onMessage.addListener((t,a,r)=>{var d;const h=()=>{var e;return("tabId"in t?t.tabId:void 0)??((e=a.tab)==null?void 0:e.id)};if(t.type==="GET_TAB_ID")return r({tabId:((d=a.tab)==null?void 0:d.id)??null}),!0;if(t.type==="ANALYZE_CLICK"){const e=h();return typeof e!="number"?(r({ok:!1,error:"No tab id available"}),!0):((async()=>{try{s(e,"Extracting page data...");const n=await B(e);w.set(e,n),s(e,"Calling analyze API...");let i;try{i=await b(n)}catch{i=z(n),s(e,"Analyze API failed, using fallback.")}f.set(e,i),N(e,i),r({ok:!0})}catch(n){const i=n instanceof Error?n.message:"Analyze failed";E(e,i),r({ok:!1,error:i})}})(),!0)}if(t.type==="CHAT_SEND"){const e=h();return typeof e!="number"?(r({ok:!1,error:"No tab id available"}),!0):((async()=>{try{const n=f.get(e),i=w.get(e);s(e,"Preparing answer...");const p=setTimeout(()=>{s(e,"Still working on your answer...")},4e3);let c;try{c=(await C({question:t.question,analyze:n,extracted:i})).message}catch{c={role:"assistant",content:"Chat API failed. Please try again."},s(e,"Chat API failed, using fallback.")}clearTimeout(p);const l=y.get(e)??[];l.push({role:"user",content:t.question}),l.push(c),y.set(e,l),v(e,c),s(e,"Chat ready"),r({ok:!0})}catch(n){const i=n instanceof Error?n.message:"Chat failed";E(e,i),r({ok:!1,error:i})}})(),!0)}if(t.type==="PANEL_INIT"){const e=f.get(t.tabId),n=y.get(t.tabId)??[];return r({ok:!0,result:e,history:n}),!0}return t.type==="CHECK_AUTH"?((async()=>{try{const{data:{session:e}}=await o.auth.getSession();if(e){r({isAuthenticated:!0});return}if(!await k()){r({isAuthenticated:!1});return}const{data:{session:i}}=await o.auth.getSession();r({isAuthenticated:!!i})}catch{r({isAuthenticated:!1,error:"Auth check failed"})}})(),!0):t.type==="SIGN_IN"?((async()=>{try{const{data:e,error:n}=await o.auth.signInWithPassword({email:t.email,password:t.password});n?r({error:n.message}):(await g(t.email,t.password),r({ok:!0}))}catch(e){r({error:e.message||"Sign in failed"})}})(),!0):t.type==="SIGN_UP"?((async()=>{try{const{data:e,error:n}=await o.auth.signUp({email:t.email,password:t.password});n?r({error:n.message}):(await g(t.email,t.password),r({ok:!0}))}catch(e){r({error:e.message||"Sign up failed"})}})(),!0):t.type==="CHECK_PREFERENCES"?((async()=>{try{const{data:{session:e}}=await o.auth.getSession();if(!(e!=null&&e.user)){r({hasPreferences:!1});return}const{data:n,error:i}=await o.from("user_preferences").select("id").eq("user_id",e.user.id).single();r({hasPreferences:!!n&&!i})}catch{r({hasPreferences:!1})}})(),!0):t.type==="GET_PREFERENCES"?((async()=>{try{const{data:{session:e}}=await o.auth.getSession();if(!(e!=null&&e.user)){r({preferences:null});return}const{data:n,error:i}=await o.from("user_preferences").select("*").eq("user_id",e.user.id).single();i&&i.code!=="PGRST116"?r({preferences:null,error:i.message}):r({preferences:n||null})}catch(e){r({preferences:null,error:e.message})}})(),!0):t.type==="SAVE_PREFERENCES"?((async()=>{try{const{data:{session:e}}=await o.auth.getSession();if(!(e!=null&&e.user)){r({error:"Not authenticated"});return}const{error:n}=await o.from("user_preferences").upsert({user_id:e.user.id,price_sensitivity:t.preferences.price||null,quality_preference:t.preferences.quality||null,brand_preference:t.preferences.brand||null,sustainability:t.preferences.sustainability||null,review_dependency:t.preferences.reviews||null,innovation_adoption:t.preferences.innovation||null},{onConflict:"user_id"});r(n?{error:n.message}:{ok:!0})}catch(e){r({error:e.message||"Failed to save preferences"})}})(),!0):!1});
