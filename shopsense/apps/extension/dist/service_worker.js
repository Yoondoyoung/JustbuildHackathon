import{s as c}from"./chunks/supabase.js";const _="http://localhost:8787",w=async()=>{const t=await chrome.storage.sync.get("apiBase");return typeof t.apiBase=="string"&&t.apiBase.length>0?t.apiBase:_},g=async t=>{const n=await w(),r=await fetch(`${n}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({extracted:t})});if(!r.ok)throw new Error(`Analyze failed: ${r.status}`);return await r.json()},b=async t=>{const n=await w(),r=await fetch(`${n}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Chat failed: ${r.status}`);return await r.json()},S="src/ui/sidepanel.html",m=()=>{var t,n;return typeof((t=chrome.sidePanel)==null?void 0:t.setOptions)=="function"&&typeof((n=chrome.sidePanel)==null?void 0:n.open)=="function"};chrome.runtime.onInstalled.addListener(()=>{m()&&chrome.sidePanel.setOptions({path:S,enabled:!0})});chrome.action.onClicked.addListener(async t=>{if(typeof t.id=="number")try{await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_SIDEBAR"})}catch{}});const f=new Map,d=new Map,y=new Map,l=t=>{try{const n=chrome.runtime.sendMessage(t);n&&typeof n.catch=="function"&&n.catch(()=>{})}catch{}},s=(t,n)=>{l({type:"STATUS",tabId:t,message:n})},E=(t,n)=>{l({type:"ERROR",tabId:t,message:n})},C=(t,n)=>{l({type:"ANALYZE_RESULT",tabId:t,result:n})},P=(t,n)=>{l({type:"CHAT_RESPONSE",tabId:t,message:n})},I=t=>({title:t.title,summary:t.title?`Analyzed ${t.title}`:"Basic analyze fallback used.",specs:t.key_specs,price:t.price,rating:t.rating,review_count:t.review_count}),T=async t=>await chrome.tabs.sendMessage(t,{type:"EXTRACT_REQUEST"});chrome.runtime.onMessage.addListener((t,n,r)=>{var p;const h=()=>{var e;return("tabId"in t?t.tabId:void 0)??((e=n.tab)==null?void 0:e.id)};if(t.type==="GET_TAB_ID")return r({tabId:((p=n.tab)==null?void 0:p.id)??null}),!0;if(t.type==="ANALYZE_CLICK"){const e=h();return typeof e!="number"?(r({ok:!1,error:"No tab id available"}),!0):((async()=>{try{s(e,"Extracting page data...");const a=await T(e);d.set(e,a),s(e,"Calling analyze API...");let i;try{i=await g(a)}catch{i=I(a),s(e,"Analyze API failed, using fallback.")}f.set(e,i),C(e,i),r({ok:!0})}catch(a){const i=a instanceof Error?a.message:"Analyze failed";E(e,i),r({ok:!1,error:i})}})(),!0)}if(t.type==="CHAT_SEND"){const e=h();return typeof e!="number"?(r({ok:!1,error:"No tab id available"}),!0):((async()=>{try{const a=f.get(e),i=d.get(e);s(e,"Sending chat request...");let o;try{o=(await b({question:t.question,analyze:a,extracted:i})).message}catch{o={role:"assistant",content:"Chat API failed. Please try again."},s(e,"Chat API failed, using fallback.")}const u=y.get(e)??[];u.push({role:"user",content:t.question}),u.push(o),y.set(e,u),P(e,o),r({ok:!0})}catch(a){const i=a instanceof Error?a.message:"Chat failed";E(e,i),r({ok:!1,error:i})}})(),!0)}if(t.type==="PANEL_INIT"){const e=f.get(t.tabId),a=y.get(t.tabId)??[];return r({ok:!0,result:e,history:a}),!0}return t.type==="CHECK_AUTH"?((async()=>{try{const{data:{session:e}}=await c.auth.getSession();r({isAuthenticated:!!e})}catch{r({isAuthenticated:!1,error:"Auth check failed"})}})(),!0):t.type==="SIGN_IN"?((async()=>{try{const{data:e,error:a}=await c.auth.signInWithPassword({email:t.email,password:t.password});r(a?{error:a.message}:{ok:!0})}catch(e){r({error:e.message||"Sign in failed"})}})(),!0):t.type==="SIGN_UP"?((async()=>{try{const{data:e,error:a}=await c.auth.signUp({email:t.email,password:t.password});r(a?{error:a.message}:{ok:!0})}catch(e){r({error:e.message||"Sign up failed"})}})(),!0):t.type==="CHECK_PREFERENCES"?((async()=>{try{const{data:{session:e}}=await c.auth.getSession();if(!(e!=null&&e.user)){r({hasPreferences:!1});return}const{data:a,error:i}=await c.from("user_preferences").select("id").eq("user_id",e.user.id).single();r({hasPreferences:!!a&&!i})}catch{r({hasPreferences:!1})}})(),!0):t.type==="GET_PREFERENCES"?((async()=>{try{const{data:{session:e}}=await c.auth.getSession();if(!(e!=null&&e.user)){r({preferences:null});return}const{data:a,error:i}=await c.from("user_preferences").select("*").eq("user_id",e.user.id).single();i&&i.code!=="PGRST116"?r({preferences:null,error:i.message}):r({preferences:a||null})}catch(e){r({preferences:null,error:e.message})}})(),!0):t.type==="SAVE_PREFERENCES"?((async()=>{try{const{data:{session:e}}=await c.auth.getSession();if(!(e!=null&&e.user)){r({error:"Not authenticated"});return}const{error:a}=await c.from("user_preferences").upsert({user_id:e.user.id,price_sensitivity:t.preferences.price||null,quality_preference:t.preferences.quality||null,brand_preference:t.preferences.brand||null,sustainability:t.preferences.sustainability||null,review_dependency:t.preferences.reviews||null,innovation_adoption:t.preferences.innovation||null},{onConflict:"user_id"});r(a?{error:a.message}:{ok:!0})}catch(e){r({error:e.message||"Failed to save preferences"})}})(),!0):!1});
