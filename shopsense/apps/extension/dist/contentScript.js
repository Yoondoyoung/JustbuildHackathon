const p=(t,e=document)=>{var n;for(const r of t){const i=e.querySelector(r),s=(n=i==null?void 0:i.textContent)==null?void 0:n.trim();if(s)return s}},y=t=>{var e;for(const n of t){const r=document.querySelector(`meta[name="${n}"], meta[property="${n}"]`),i=(e=r==null?void 0:r.getAttribute("content"))==null?void 0:e.trim();if(i)return i}},w=t=>{if(!t)return;const e=t.replace(/[^0-9.]/g,""),n=Number(e);return Number.isFinite(n)?n:void 0},z=t=>{if(!t)return;const e=t.replace(/,/g,"").match(/(\d+(\.\d+)?)/);return e?w(e[1]):void 0},M=(t,e="USD")=>t?t.includes("£")?"GBP":t.includes("€")?"EUR":t.includes("¥")?"JPY":t.includes("₩")?"KRW":t.includes("$")?"USD":e:e,P=t=>t.replace(/[:：]\s*$/,"").trim(),I=(t,e,n)=>{const r=e?P(e):"",i=(n==null?void 0:n.trim())??"";!r||!i||t[r]||(t[r]=i)},B=(t,e)=>{t.querySelectorAll("table").forEach(n=>{n.querySelectorAll("tr").forEach(r=>{var i,s;I(e,(i=r.querySelector("th"))==null?void 0:i.textContent,(s=r.querySelector("td"))==null?void 0:s.textContent)})}),t.querySelectorAll("dl").forEach(n=>{Array.from(n.querySelectorAll("dt")).forEach(i=>{var s;I(e,i.textContent,(s=i.nextElementSibling)==null?void 0:s.textContent)})}),t.querySelectorAll("li").forEach(n=>{const r=n.querySelector("span.a-text-bold, strong, b");if(!r)return;const i=r.textContent??"",s=P(i);if(!s)return;const c=(n.textContent??"").replace(i,"").replace(/^[\s:-]+/,"").trim();I(e,s,c)})},L=(t=document)=>{const e={};return B(t,e),Object.keys(e).length>0?e:void 0},Y=["[itemprop=review]","[data-hook=review]",".review",".reviews-list .review-item","[data-testid=review-card]",".ugc-review-body"],N=(t=Y,e=document)=>{const n=[];return e.querySelectorAll(t.join(",")).forEach(r=>{var s;if(n.length>=5)return;const i=(s=r.textContent)==null?void 0:s.trim();i&&i.length>20&&n.push(i.replace(/\s+/g," "))}),n.length>0?n:void 0},G=()=>{var a;const t=y(["og:title","twitter:title"])||p(["h1","[itemprop=name]","[data-test=product-title]"])||document.title,e=y(["product:brand","og:brand"])||p(["[itemprop=brand]","[data-brand]",".brand",".product-brand"]),n=y(["product:mpn","product:model"])||p(["[itemprop=mpn]","[data-model]"]),r=y(["product:price:amount","price","og:price:amount"])||p(["[itemprop=price]","[data-test=product-price]",".price"]),i=y(["product:price:currency","price:currency"])||((a=document.querySelector("[itemprop=priceCurrency]"))==null?void 0:a.getAttribute("content"))||M(r,"USD"),s=y(["rating","ratingValue"])||p(["[itemprop=ratingValue]","[data-test=rating]",".rating"]),o=y(["reviewCount"])||p(["[itemprop=reviewCount]","[data-hook=total-review-count]",".review-count"]),c=w(r);return{title:t,brand:e,model:n,price:c!==void 0?{value:c,currency:i}:void 0,rating:z(s),review_count:w(o),key_specs:L(),visible_reviews:N()}},K=t=>t&&t.replace(/^Brand:\s*/i,"").replace(/^Visit the\s*/i,"").replace(/\s*Store$/i,"").trim()||void 0,W=()=>{const t={};["#productDetails_techSpec_section_1","#productDetails_detailBullets_sections1","#technicalSpecifications_feature_div","#detailBullets_feature_div","#detailBulletsWrapper_feature_div","#prodDetails"].forEach(r=>{const i=document.querySelector(r);i&&B(i,t)});const n=L();return n&&Object.entries(n).forEach(([r,i])=>{t[r]||(t[r]=i)}),Object.keys(t).length>0?t:void 0},F=()=>p(["#mir-layout-DELIVERY_BLOCK-slot-PRIMARY_DELIVERY_MESSAGE_LARGE","#mir-layout-DELIVERY_BLOCK-slot-DELIVERY_MESSAGE","#deliveryMessageMirId","#deliveryMessage","#mir-layout-DELIVERY_BLOCK-slot-PRIMARY_DELIVERY_MESSAGE_SMALL"]),Z=()=>{const t=p(["#productTitle","h1#title"]),e=document.querySelector("#bylineInfo"),n=K((e==null?void 0:e.getAttribute("aria-label"))??(e==null?void 0:e.textContent)??""),r=p(["#corePrice_feature_div .a-offscreen","#apex_desktop .a-price .a-offscreen","#priceblock_ourprice","#priceblock_dealprice","#priceblock_saleprice"])??y(["product:price:amount","price","og:price:amount"]),i=w(r),s=y(["product:price:currency","price:currency"])||M(r,"USD"),o=document.querySelector("#acrPopover"),c=(o==null?void 0:o.getAttribute("title"))||(o==null?void 0:o.textContent)||p(["#averageCustomerReviews .a-icon-alt","span[data-hook=rating-out-of-text]"]),a=p(["#acrCustomerReviewText","span[data-hook=total-review-count]"]),l=W(),u=(l==null?void 0:l["Item model number"])||(l==null?void 0:l.Model)||p(["[itemprop=mpn]"]);return{title:t,brand:n,model:u,price:i!==void 0?{value:i,currency:s}:void 0,rating:z(c),review_count:w(a),key_specs:l,visible_reviews:N(["[data-hook=review-body]",".review-text","[data-hook=review]"]),shipping_returns:F()}},J=()=>{var o;const t={},e=document.querySelector('[data-testid="brix-sheet"]');e&&e.querySelectorAll('div.inline-flex.w-full, div[class*="inline-flex"][class*="w-full"], div[class*="dB7j8sHUbncyf79K"]').forEach(a=>{var d,f;const l=a.querySelector('div.font-weight-medium, div[class*="font-weight-medium"]'),u=a.querySelector('div[class*="pl-300"], div.grow.basis-none[class*="pl-300"]');if(l&&u){const b=l.cloneNode(!0);b.querySelectorAll("button").forEach(E=>E.remove());let x=((d=b.textContent)==null?void 0:d.trim())||"";const m=((f=u.textContent)==null?void 0:f.trim())||"";x=x.replace(/\s+/g," ").trim(),x&&m&&x.length>0&&m.length>0&&(t[x]=m)}});const n=document.querySelectorAll("h2.h5");let r=null;for(const c of Array.from(n))if(((o=c.textContent)==null?void 0:o.trim())==="Highlights"){r=c;break}if(r){const c=r.parentElement;c&&c.querySelectorAll("button.c-button-unstyled").forEach(l=>{var d,f,b;const u=l.querySelector("div.flex.flex-column");if(u){const h=u.querySelector("div:first-child"),x=u.querySelector('div.font-500, div[class*="font-500"]');if(h&&x){const m=h.cloneNode(!0);m.querySelectorAll("svg").forEach(q=>q.remove());let v=((d=m.textContent)==null?void 0:d.trim())||"",g=((f=x.textContent)==null?void 0:f.trim())||"";const C=x.cloneNode(!0);C.querySelectorAll("svg").forEach(q=>q.remove()),g=((b=C.textContent)==null?void 0:b.trim())||"",v=v.replace(/\s+/g," ").trim(),g=g.replace(/\s+/g," ").trim(),v&&g&&v.length>0&&g.length>0&&(t[v]||(t[v]=g))}}})}["#specifications",".specifications",".specification-table",".product-data"].forEach(c=>{const a=document.querySelector(c);a&&B(a,t)});const s=L();return s&&Object.entries(s).forEach(([c,a])=>{t[c]||(t[c]=a)}),Object.keys(t).length>0?t:void 0},Q=()=>{var o,c,a,l;const t=document.querySelector('[data-component-name="FulfillmentSelector"]');if(!t)return p([".fulfillment-additional-info",".availabilityMessage",".fulfillment-fulfillment-summary"]);const e=[],n=t.querySelector('button[data-test-id="pickup"]');if(n){const d=(n.getAttribute("aria-label")||"").match(/(?:Ready on|Pickup)\s+([^,]+,\s*[^,]+)/i);if(d)e.push(`Pickup: ${d[1]}`);else{const f=(c=(o=n.querySelector("strong"))==null?void 0:o.textContent)==null?void 0:c.trim();f&&e.push(`Pickup: ${f}`)}}const r=t.querySelector('button[data-test-id="shipping"]');if(r){const d=(r.getAttribute("aria-label")||"").match(/(?:Get it by|Shipping)\s+([^,]+,\s*[^,]+)/i);if(d)e.push(`Shipping: ${d[1]}`);else{const f=(l=(a=r.querySelector("strong"))==null?void 0:a.textContent)==null?void 0:l.trim();f&&e.push(`Shipping: ${f}`)}}const s=(t.textContent||"").match(/Order now for pickup on ([^a]+) at\s+([^<]+)/i);return s&&e.push(`Pickup location: ${s[2].trim()}`),e.length>0?e.join(" - "):void 0},X=()=>{var f,b,h,x,m,E;const t=p([".sku-title h1","h1.sku-title","h1"]);let e;const n=document.querySelector('[data-component-name="ProductHeader"]');if(n){const v=n.querySelector(".description a");e=(f=v==null?void 0:v.textContent)==null?void 0:f.trim()}let r;if(n){const v=n.querySelector(".disclaimer");if(v){const C=(v.textContent||"").match(/Model:\s*([^\s]+)/i);C&&(r=C[1])}}let i;const s=document.querySelector('[data-testid="price-block-customer-price"]');s&&(i=(b=s.textContent)==null?void 0:b.trim()),i||(i=p([".priceView-hero-price span",".priceView-customer-price span","[data-testid=customer-price]",".pricing-price__regular-price"])??y(["product:price:amount","price","og:price:amount"]));const o=w(i),c=y(["product:price:currency","price:currency"])||M(i,"USD");let a,l;const u=document.querySelector('[data-component-name="ReviewStatsContextualized"]');if(u){const v=u.querySelector("span.font-weight-bold");if(a=(h=v==null?void 0:v.textContent)==null?void 0:h.trim(),!a){const k=(((x=u.querySelector("p.visually-hidden"))==null?void 0:x.textContent)||"").match(/Rating\s+(\d+(?:\.\d+)?)\s+out\s+of/i);k&&(a=k[1])}const g=u.querySelector("span.c-reviews"),D=(((m=g==null?void 0:g.textContent)==null?void 0:m.trim())||"").match(/(\d+)\s*review/i);if(D&&(l=D[1]),!l){const k=(((E=u.querySelector("p.visually-hidden"))==null?void 0:E.textContent)||"").match(/(\d+)\s+review/i);k&&(l=k[1])}}a||(a=p([".c-review-average",".ugc-c-review-average","[data-automation=overall-rating]"])),l||(l=p([".c-review-count",".ugc-c-review-count","[data-automation=review-count]"]));const d=J();return e=e||(d==null?void 0:d.Brand)||(d==null?void 0:d["Brand Name"]),r=r||(d==null?void 0:d.Model)||(d==null?void 0:d["Model Number"]),{title:t,brand:e,model:r,price:o!==void 0?{value:o,currency:c}:void 0,rating:z(a),review_count:w(l),key_specs:d,visible_reviews:N(["[data-component-name=CustomerReviewListSection] #review-list li p","#review-list li p","[data-testid=enhanced-review-content]","[data-testid=review-card]",".ugc-review-body",".review-text",".review-item"]),shipping_returns:Q()}},tt=()=>{const t={};["[data-testid=specifications-section]","[data-testid=product-specifications]","#product-specifications","#specifications"].forEach(r=>{const i=document.querySelector(r);i&&B(i,t)});const n=L();return n&&Object.entries(n).forEach(([r,i])=>{t[r]||(t[r]=i)}),Object.keys(t).length>0?t:void 0},et=()=>{var a,l,u;const t=document.querySelector("#fulfillment-Shipping-content");if(!t)return;const e=[],n=t.querySelector('[data-seo-id="fulfillment-shipping-intent"]'),r=(a=n==null?void 0:n.textContent)==null?void 0:a.trim();r&&e.push(r);const i=n==null?void 0:n.nextElementSibling,s=(l=i==null?void 0:i.textContent)==null?void 0:l.trim();s&&s!==r&&e.push(s);const o=t.querySelector(".f7.b.green, .f7.b"),c=(u=o==null?void 0:o.textContent)==null?void 0:u.trim();return c&&e.push(c),e.length>0?e.join(" - "):void 0},nt=()=>{const t=[];return document.querySelectorAll('[data-testid="enhanced-review-content"]').forEach(n=>{var c,a;if(t.length>=5)return;const r=n.querySelector("h3"),i=((c=r==null?void 0:r.textContent)==null?void 0:c.trim())||"",s=n.querySelector('p[tabindex="-1"]'),o=((a=s==null?void 0:s.textContent)==null?void 0:a.trim())||"";if(o&&o.length>20){const l=i?`${i}. ${o}`:o;t.push(l.replace(/\s+/g," "))}}),t.length>0?t:void 0},rt=()=>{var u,d,f;const t=p(["[data-testid=product-title]","h1","[itemprop=name]"]),e=p(["[data-testid=brand-name]","[itemprop=brand]","a[data-testid=brand-name]","[data-automation-id=brand-name]"]),n=p(["[data-testid=price-wrap] [itemprop=price]","[data-testid=price-wrap]","[data-testid=price]","[itemprop=price]","[data-automation-id=product-price]"])??y(["product:price:amount","price","og:price:amount"]),r=w(n),i=y(["product:price:currency","price:currency"])||M(n,"USD"),s=document.querySelector('[data-testid="reviews-and-ratings"]');let o,c;if(s){const b=s.querySelector("span.w_iUH7");if(b){const h=((u=b.textContent)==null?void 0:u.trim())||"",x=h.match(/(\d+\.?\d*)\s*stars?/i);x&&(o=x[1]);const m=h.match(/(\d+(?:,\d+)?)\s*reviews?/i);m&&(c=m[1])}if(!o){const h=s.querySelector("span.f7"),m=(((d=h==null?void 0:h.textContent)==null?void 0:d.trim())||"").match(/\((\d+\.?\d*)\)/);m&&(o=m[1])}if(!c){const h=s.querySelector('[itemprop="ratingCount"]'),m=(((f=h==null?void 0:h.textContent)==null?void 0:f.trim())||"").match(/(\d+(?:,\d+)?)/);m&&(c=m[1])}}o||(o=p(["[data-testid=reviews-rating]","[itemprop=ratingValue]",".stars-container"])),c||(c=p(["[data-testid=reviews-header]","[data-testid=reviews-count]","[itemprop=reviewCount]",".stars-reviews-count"]));const a=tt(),l=(a==null?void 0:a.Model)||(a==null?void 0:a["Model Number"]);return{title:t,brand:e,model:l,price:r!==void 0?{value:r,currency:i}:void 0,rating:z(o),review_count:w(c),key_specs:a,visible_reviews:nt()||N(["[data-testid=review-card]","[data-testid=review-text]","[data-testid=review-body]",".review-text",".prod-ProductReview",".review-body","[data-automation-id=review-text]","section[data-testid=reviews-section] [data-testid=review-card]"]),shipping_returns:et()}},ot=t=>{const e=t.toLowerCase();return e.includes("amazon.")?Z:e.includes("walmart.")?rt:e.endsWith("bestbuy.com")?X:null},it=(t,e)=>{var r;const n={...t.key_specs??{},...e.key_specs??{}};return{page_url:location.href,store_domain:location.host,title:e.title??t.title,brand:e.brand??t.brand,model:e.model??t.model,price:e.price??t.price,rating:e.rating??t.rating,review_count:e.review_count??t.review_count,key_specs:Object.keys(n).length>0?n:void 0,visible_reviews:(r=e.visible_reviews)!=null&&r.length?e.visible_reviews:t.visible_reviews,shipping_returns:e.shipping_returns??t.shipping_returns}},ct=()=>{const t=G(),e=ot(location.host),n=e?e():{};return it(t,n)},j="shopsense-sidebar";let $=null,T=null,O=null,V=null,R=null,_=null,S=null;const st=async()=>{try{const t=await chrome.runtime.sendMessage({type:"GET_TAB_ID"});if(typeof(t==null?void 0:t.tabId)=="number")return t.tabId}catch{}return null},A=t=>{if(!O||!T)return;O.textContent=t,T.classList.remove("busy","error");const e=t.toLowerCase();e.includes("fail")||e.includes("error")?T.classList.add("error"):(e.includes("analyz")||e.includes("send"))&&T.classList.add("busy")},at=(t,e)=>{var i,s;t.innerHTML="";const n=document.createElement("h2");n.textContent=e.title??"Analyze",t.appendChild(n);const r=document.createElement("p");if(r.textContent=e.summary??"No summary available.",t.appendChild(r),e.price){const o=document.createElement("div");o.className="meta-row",o.textContent=`Price: ${e.price.value} ${e.price.currency}`,t.appendChild(o)}if(e.rating!==void 0){const o=document.createElement("div");o.className="meta-row",o.textContent=`Rating: ${e.rating}`,t.appendChild(o)}if(e.review_count!==void 0){const o=document.createElement("div");o.className="meta-row",o.textContent=`Reviews: ${e.review_count}`,t.appendChild(o)}if((i=e.key_points)!=null&&i.length){const o=document.createElement("ul");e.key_points.forEach(c=>{const a=document.createElement("li");a.textContent=c,o.appendChild(a)}),t.appendChild(o)}if(e.specs&&Object.keys(e.specs).length>0){const o=document.createElement("div");o.className="specs",Object.entries(e.specs).forEach(([c,a])=>{const l=document.createElement("div");l.className="spec-row",l.textContent=`${c}: ${a}`,o.appendChild(l)}),t.appendChild(o)}if((s=e.citations)!=null&&s.length){const o=document.createElement("div");o.className="citations",e.citations.forEach(c=>{const a=document.createElement("a");a.href=c.url,a.target="_blank",a.rel="noreferrer",a.textContent=c.title??c.url,o.appendChild(a)}),t.appendChild(o)}},H=(t,e)=>{var i;const n=document.createElement("div");n.className=`chat-message ${e.role}`;const r=document.createElement("div");if(r.className="chat-text",r.textContent=e.content,n.appendChild(r),(i=e.citations)!=null&&i.length){const s=document.createElement("div");s.className="chat-citations",e.citations.forEach(o=>{const c=document.createElement("a");c.href=o.url,c.target="_blank",c.rel="noreferrer",c.textContent=o.title??o.url,s.appendChild(c)}),n.appendChild(s)}t.appendChild(n),t.scrollTop=t.scrollHeight},U=()=>{if(S)return;const t=document.getElementById(j);if(t){S=t;return}const e=document.createElement("div");e.id=j,e.style.position="fixed",e.style.inset="16px 16px auto auto",e.style.top="16px",e.style.right="16px",e.style.left="auto",e.style.margin="0",e.style.transform="none",e.style.width="340px",e.style.height="calc(100vh - 32px)",e.style.zIndex="2147483647",e.style.display="none";const n=e.attachShadow({mode:"open"});n.innerHTML=`
    <style>
      :host { all: initial; }
      * { box-sizing: border-box; font-family: system-ui, sans-serif; }
      .sidebar { height: 100%; background: #fff; border-radius: 16px; border: 1px solid #f0f0f0;
        box-shadow: 0 8px 30px rgba(0,0,0,0.12); display: flex; flex-direction: column; overflow: hidden; }
      .header { padding: 16px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
      .title { font-size: 18px; font-weight: 700; color: #111827; }
      .status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #6b7280; }
      .dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; }
      .dot.busy { background: #f59e0b; }
      .dot.error { background: #ef4444; }
      .action { padding: 14px 16px; border-bottom: 1px solid #eee; }
      .btn { border: none; border-radius: 10px; padding: 10px 12px; cursor: pointer; font-weight: 600; font-size: 13px; }
      .btn-secondary { width: 100%; background: #f3f4f6; color: #111827; }
      .btn-primary { background: #3b82f6; color: #fff; }
      .content { flex: 1; padding: 16px; background: #fafafa; overflow-y: auto; }
      .panel { background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
      .panel h2 { margin: 0 0 8px 0; font-size: 14px; }
      .meta-row { font-size: 13px; margin-top: 4px; color: #4b5563; }
      .specs { margin-top: 8px; font-size: 12px; }
      .spec-row { padding: 4px 0; border-bottom: 1px solid #eee; }
      .chat-log { max-height: 220px; overflow-y: auto; font-size: 13px; }
      .chat-message { padding: 8px; border-radius: 10px; margin-bottom: 8px; background: #f3f4f6; }
      .chat-message.user { background: #e0ecff; }
      .chat-citations a { display: block; font-size: 11px; color: #3b82f6; }
      .chat-input { padding: 12px 16px 16px; border-top: 1px solid #eee; background: #fff; position: relative; }
      .chat-input textarea { width: 100%; padding: 12px 48px 12px 12px; border-radius: 12px; border: 1px solid #e5e7eb; background: #f9fafb; resize: none; outline: none; font-size: 13px; }
      .chat-input button { position: absolute; right: 22px; bottom: 22px; }
    </style>
    <div class="sidebar">
      <div class="header">
        <div class="title">ShopSense</div>
        <div class="status"><span class="dot" id="ss-status-dot"></span><span id="ss-status-text">Idle</span></div>
      </div>
      <div class="action">
        <button id="ss-analyze" class="btn btn-secondary" type="button">Analyze Page</button>
      </div>
      <div class="content">
        <section id="ss-analyze" class="panel"></section>
        <section class="panel">
          <h2>Chat</h2>
          <div id="ss-chat" class="chat-log"></div>
        </section>
      </div>
      <form id="ss-chat-form" class="chat-input">
        <textarea id="ss-chat-input" rows="2" placeholder="Ask about this product..."></textarea>
        <button class="btn btn-primary" type="submit">Send</button>
      </form>
    </div>
  `,document.documentElement.appendChild(e),S=e,T=n.querySelector("#ss-status-dot"),O=n.querySelector("#ss-status-text"),V=n.querySelector("#ss-analyze"),R=n.querySelector("#ss-chat"),_=n.querySelector("#ss-chat-input");const r=n.querySelector("#ss-analyze"),i=n.querySelector("#ss-chat-form");r.addEventListener("click",async()=>{A("Analyzing..."),await chrome.runtime.sendMessage({type:"ANALYZE_CLICK"})}),i.addEventListener("submit",async s=>{s.preventDefault();const o=(_==null?void 0:_.value.trim())??"";!o||!R||(H(R,{role:"user",content:o}),_&&(_.value=""),await chrome.runtime.sendMessage({type:"CHAT_SEND",question:o}))})},lt=()=>{U(),S&&(S.style.display="block")},dt=()=>{if(U(),!S)return;const t=S.style.display==="none";S.style.display=t?"block":"none"},ut=()=>{const t=ct();return console.log("[ShopSense] extracted",t),t};chrome.runtime.onMessage.addListener((t,e,n)=>t.type==="EXTRACT_REQUEST"?(n(ut()),!0):t.tabId&&$&&t.tabId!==$?!1:t.type==="TOGGLE_SIDEBAR"?(dt(),!0):(lt(),t.type==="STATUS"||t.type==="ERROR"?(A(t.message),!0):t.type==="ANALYZE_RESULT"&&V?(at(V,t.result),A("Analyze completed"),!0):t.type==="CHAT_RESPONSE"&&R?(H(R,t.message),A("Chat ready"),!0):!1));const pt=async()=>{$=await st()};pt();
